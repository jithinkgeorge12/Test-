WITH json_data AS (
  SELECT 
    notification_id,
    JSON_QUERY(payload, '$.data') AS data_json
  FROM inbounddetails
),
properties_extracted AS (
  SELECT 
    notification_id,
    JSON_VALUE(data_json, '$.properties.firstName') AS firstName,
    JSON_VALUE(data_json, '$.properties.lastName') AS lastName,
    data_json
  FROM json_data
),
fund_details AS (
  SELECT 
    pe.notification_id,
    pe.firstName,
    pe.lastName,
    fk.key AS fund_key,
    JSON_VALUE(JSON_QUERY(pe.data_json, '$.properties.' || fk.key || '.collection.properties'), '$.currency') AS currency,
    JSON_VALUE(JSON_QUERY(pe.data_json, '$.properties.' || fk.key || '.collection.properties'), '$.domicile') AS domicile
  FROM properties_extracted pe,
    JSON_TABLE(
      pe.data_json,
      '$.properties'
      COLUMNS (
        key VARCHAR2(4000) PATH 'lax $.*'
      )
    ) fk
  WHERE fk.key LIKE 'fundDetails%'
)
SELECT 
  fd.notification_id,
  fd.firstName,
  fd.lastName,
  fd.fund_key,
  fd.currency,
  fd.domicile
FROM fund_details fd;

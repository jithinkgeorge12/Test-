WITH json_data AS (
  SELECT 
    id,
    draftid,
    JSON_QUERY(payload, '$.data') AS data_json
  FROM inbounddetails
),
properties_extracted AS (
  SELECT 
    id,
    draftid,
    JSON_VALUE(data_json, '$.properties.firstname.value') AS firstname,
    JSON_VALUE(data_json, '$.properties.lastname.value') AS lastname,
    JSON_VALUE(data_json, '$.properties.officecode.value') AS officecode,
    JSON_QUERY(data_json, '$.properties') AS properties_json
  FROM json_data
),
fund_keys AS (
  SELECT 
    id,
    draftid,
    properties_json,
    key
  FROM properties_extracted,
    JSON_TABLE(
      properties_json,
      '$'
      COLUMNS (
        key VARCHAR2(4000) PATH 'lax $.*'
      )
    )
  WHERE key LIKE 'funddetails%'
),
fund_details AS (
  SELECT 
    fk.id,
    fk.draftid,
    fk.key AS fund_key,
    JSON_QUERY(fk.properties_json, '$.' || fk.key || '.collection.properties') AS fund_properties_json
  FROM fund_keys fk
)
SELECT 
  fd.id,
  fd.draftid,
  pe.firstname,
  pe.lastname,
  pe.officecode,
  fd.fund_key,
  JSON_VALUE(fd.fund_properties_json, '$.currency') AS currency,
  JSON_VALUE(fd.fund_properties_json, '$.domicile') AS domicile
FROM fund_details fd
JOIN properties_extracted pe ON fd.id = pe.id AND fd.draftid = pe.draftid;

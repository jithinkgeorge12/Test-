import * as XLSX from 'xlsx';

const Download = {
  generateExcel: (rawdata, group) => {
    const sortedGroup = sortGroup(group); // Sort group alphabetically

    const dataForDownload = prepareDataForDownload(rawdata, sortedGroup);

    downloadExcel(dataForDownload);
  }
};

const sortGroup = (group) => {
  return group.sort((a, b) => a.localeCompare(b));
};

const prepareDataForDownload = (rawdata, group) => {
  let data = [];

  rawdata.forEach((item, index) => {
    group.forEach((code) => {
      const ref = `a${data.length + 1}`.padStart(9, '0');
      const date = new Date(item.date);
      const formattedDate = `${date.getDate()}${date.getMonth() + 1}${date.getFullYear() % 100}`;
      
      const row = {
        ref,
        code,
        date: formattedDate,
        valuation: 0,
      };

      data.push(row);
    });
  });

  return data;
};

const downloadExcel = (data) => {
  const wb = generateWorkbook(data);
  const wbout = writeWorkbook(wb);

  triggerDownload(wbout);
};

const generateWorkbook = (data) => {
  const wb = {
    SheetNames: ['Sheet1'],
    Sheets: {
      'Sheet1': generateWorksheet(data),
    },
  };
  return wb;
};

const generateWorksheet = (data) => {
  return XLSX.utils.json_to_sheet(data);
};

const writeWorkbook = (wb) => {
  return XLSX.write(wb, { bookType: 'xls', type: 'array' });
};

const triggerDownload = (wbout) => {
  const blob = new Blob([wbout], { type: 'application/vnd.ms-excel' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'D24.xls'; // Set the filename here

  document.body.appendChild(a);
  a.click();

  setTimeout(() => {
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }, 0);
};

export default Download;
